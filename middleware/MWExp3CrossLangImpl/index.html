

<!DOCTYPE html>
<html lang="zh-TW" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/avatar.png">
  <link rel="icon" href="/img/avatar.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="
简单的AES，雕虫小技的跨语言调用……
">
  <meta name="author" content="Enatsu">
  <meta name="keywords" content="">
  
  <title>《中间件技术》实验3：跨语言加密解密调用 - Enatsu&#39;s Site</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.6.0/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.7.2/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->

  
<link rel="stylesheet" href="/css/custom.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","version":"1.8.11","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Enatsu's Site</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首頁
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                歸檔
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分類
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                標籤
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                關於
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友站
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
    <div class="text-center navbar-convert-div"><button id="btn-simplify" type="button" class="navbar-convert">繁</button></div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/images/Thrift.jfif') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="《中间件技术》实验3：跨语言加密解密调用">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-04-19 23:40" pubdate>
        2021年4月19日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      凡 2.8k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      12
       分鐘
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">《中间件技术》实验3：跨语言加密解密调用</h1>
            
            <div class="markdown-body">
              <blockquote>
<p>简单的<em>AES</em>，雕虫小技的跨语言调用……</p>
</blockquote>
<span id="more"></span>

<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p><strong>实验目的</strong>：搜索跨语言开发调用的常用框架/库，阅读文档；实现简单的跨语言调用。</p>
<p><strong>实验内容</strong>：</p>
<p> 一个功能A，用的是L1语言进行编程实现的；请把该功能，在L2语言的环境下进行调用/合并，并能正确的返回结果。</p>
<p>请先自己编写或找到实现A功能的代码，或仅有可执行文件，并进行跨语言开发。</p>
<p>多语言开发一般基于第三方的库或解决方案。</p>
<p>（2.3 A：加密和解密功能， L1: Java， L2：C++ 和 Python）</p>
<h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><p>首先，如果不考虑利用其他框架来进行跨语言调用，最简单的办法自然是直接调用控制台输出。或者，设计RESTful API也可满足要求。</p>
<p>不过，对于Python调用Java，我们容易找到<code>jpype</code>这个工具，通过开启JVM，调用已经编译好的jar包中的类。另外，C++也可利用JNI来调用jar包。</p>
<p>此外，通过Apache Thrift这一个远程过程调用（RPC）框架，约定传输的类，建立相应的C/S程序，我们也可以很容易地实现跨语言的编程与调用。</p>
<p>对于加密和解密功能，由于Base64过于简单，这里选择了AES加密算法。通过约定相同的密钥进行加密和加密。</p>
<p>项目仓库地址：<a target="_blank" rel="noopener" href="https://github.com/unsioer/EncryptorDecryptor">https://github.com/unsioer/EncryptorDecryptor</a></p>
<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>编译器：</p>
<ul>
<li>JDK 11</li>
<li>MSVC 14</li>
<li>Python 3.8</li>
<li>Thrift 1.4</li>
</ul>
<p>IDE：</p>
<ul>
<li>IDEA 社区版（Java代码开发）</li>
<li>Visual Studio 2019（C++代码开发）</li>
<li>Visual Studio Code（Python代码开发）</li>
</ul>
<p>包管理工具：</p>
<ul>
<li>maven（Java）</li>
<li>vcpkg（C++）</li>
<li>pip（Python）</li>
</ul>
<h2 id="详细设计"><a href="#详细设计" class="headerlink" title="详细设计"></a>详细设计</h2><h3 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h3><p>如下表所示。</p>
<table>
<thead>
<tr>
<th align="center">Java</th>
<th align="center">C++</th>
<th align="center">Python</th>
</tr>
</thead>
<tbody><tr>
<td align="center">实现了Base64和AES加密/解密算法。<br />选用AES测试跨语言调用实验。<br />1. 将项目打包成jar包，供Python的<code>jpype</code>调用其中的<code>MyAES</code>类。<br />2. 通过Thrift生成代码，编写相应的服务端（供C++和Python调用）和客户端程序。</td>
<td align="center">通过Thrift生成代码，编写客户端程序调用Java的方法。</td>
<td align="center">1. 通过<code>jpype</code>调用Java打包生成的的jar包中的类。<br />2. 通过Thrift生成代码，编写客户端程序调用Java的方法。</td>
</tr>
</tbody></table>
<h3 id="附注：Base64在Java中的实现"><a href="#附注：Base64在Java中的实现" class="headerlink" title="附注：Base64在Java中的实现"></a>附注：Base64在Java中的实现</h3><p>首先简要介绍Base64。Base64就是一种基于64个可打印字符来表示二进制数据的方法。采用Base64编码具有不可读性，需要解码后才能阅读。它要求每三个8Bit的字节转换为四个6Bit（$2^6=64$）的字节，然后把6Bit再添两位高位0，组成四个8Bit的字节。最后得到的每个字节数值范围为00000000~00111111，依次转换为大写字母、小写字母、数字（0-9）、+和/，共计26+26+10+1+1=64个字符。原文的字节数量如果是3的倍数，自然按上述规则转换；如不满足，则将剩余的字节按原有规则转换（余1字节，转2字节；余2字节，转3字节。每个字节最高2位补零，剩余凑不满6的倍数的低位也补零），最后用2个或1个=号补满四个字节。</p>
<p>我们可以直接调用<code>java.util.Base64</code>的静态方法实现Base64的功能。读取内容为字符串，故统一先作UTF-8编码。由于编码方法简单，也不算真正意义上的加/解“密”，故本次实验不对其做跨语言调用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyBase64</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">static</span> String <span class="hljs-title">encode</span><span class="hljs-params">(String content)</span> </span>&#123;<br>        Base64.Encoder encoder = Base64.getEncoder();<br>        <span class="hljs-keyword">byte</span>[] contentByte = content.getBytes(StandardCharsets.UTF_8);<br>        <span class="hljs-keyword">return</span> encoder.encodeToString(contentByte);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">static</span> String <span class="hljs-title">decode</span><span class="hljs-params">(String content)</span> </span>&#123;<br>        Base64.Decoder decoder = Base64.getDecoder();<br>        <span class="hljs-keyword">byte</span>[] contentByte = content.getBytes(StandardCharsets.UTF_8);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> String(decoder.decode(contentByte), StandardCharsets.UTF_8);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="AES在Java中的实现"><a href="#AES在Java中的实现" class="headerlink" title="AES在Java中的实现"></a>AES在Java中的实现</h3><p>密码学中的高级加密标准（Advanced Encryption Standard，AES），又称Rijndael加密法。该算法为比利时密码学家Joan Daemen和Vincent Rijmen所设计，结合两位作者的姓氏，以Rijdael命名。AES采用置换-组合架构进行加解密。严格地说，AES只是Rijndael的特例。AES的区块长度固定为128位，密钥长度则可以是128，192或256位；而Rijndael使用的密钥和区块长度可以是32位的整数倍，以128位为下限，256位为上限。AES加解密过程中使用的密钥是由Rijndael密钥生成方案产生。</p>
<p>下面的AES加密/解密代码流程如下：</p>
<ul>
<li><p>首先把<code>encodeRules</code>作为随机数种子，生成128位密钥。</p>
</li>
<li><p>然后，加密过程对<code>content</code>字符串进行加密，将最后的字节编码结果转换为Base64串输出；</p>
</li>
<li><p>解密过程则相反，先把<code>content</code>（Base64串）解码成字节内容，最后通过AES解码输出结果。</p>
<p>这里尝试的都是字符串，故对编码输入和解码输出均按UTF-8编码。</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.crypto.*;<br><span class="hljs-keyword">import</span> javax.crypto.spec.SecretKeySpec;<br><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><span class="hljs-keyword">import</span> java.security.InvalidKeyException;<br><span class="hljs-keyword">import</span> java.security.NoSuchAlgorithmException;<br><span class="hljs-keyword">import</span> java.security.SecureRandom;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyAES</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">AESEncode</span><span class="hljs-params">(String encodeRules, String content)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            KeyGenerator keygen = KeyGenerator.getInstance(<span class="hljs-string">&quot;AES&quot;</span>);<br>            SecureRandom random = SecureRandom.getInstance(<span class="hljs-string">&quot;SHA1PRNG&quot;</span>);<br>            random.setSeed(encodeRules.getBytes());<br>            keygen.init(<span class="hljs-number">128</span>, random);<br>            SecretKey originalKey = keygen.generateKey();<br>            <span class="hljs-keyword">byte</span>[] raw = originalKey.getEncoded();<br>            SecretKey key = <span class="hljs-keyword">new</span> SecretKeySpec(raw, <span class="hljs-string">&quot;AES&quot;</span>);<br>            Cipher cipher = Cipher.getInstance(<span class="hljs-string">&quot;AES&quot;</span>);<br>            cipher.init(Cipher.ENCRYPT_MODE, key);<br>            <span class="hljs-keyword">byte</span>[] contentByte = content.getBytes(StandardCharsets.UTF_8);<br>            <span class="hljs-keyword">byte</span>[] aesByte = cipher.doFinal(contentByte);<br>            Base64.Encoder encoder = Base64.getEncoder();<br>            <span class="hljs-keyword">return</span> encoder.encodeToString(aesByte);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchAlgorithmException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchPaddingException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (InvalidKeyException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalBlockSizeException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (BadPaddingException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">AESDecode</span><span class="hljs-params">(String encodeRules, String content)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            KeyGenerator keygen = KeyGenerator.getInstance(<span class="hljs-string">&quot;AES&quot;</span>);<br>            SecureRandom random = SecureRandom.getInstance(<span class="hljs-string">&quot;SHA1PRNG&quot;</span>);<br>            random.setSeed(encodeRules.getBytes());<br>            keygen.init(<span class="hljs-number">128</span>, random);<br>            SecretKey originalKey = keygen.generateKey();<br>            <span class="hljs-keyword">byte</span>[] raw = originalKey.getEncoded();<br>            SecretKey key = <span class="hljs-keyword">new</span> SecretKeySpec(raw, <span class="hljs-string">&quot;AES&quot;</span>);<br>            Cipher cipher = Cipher.getInstance(<span class="hljs-string">&quot;AES&quot;</span>);<br>            cipher.init(Cipher.DECRYPT_MODE, key);<br>            Base64.Decoder decoder = Base64.getDecoder();<br>            <span class="hljs-keyword">byte</span>[] contentByte = decoder.decode(content.getBytes());<br>            <span class="hljs-keyword">byte</span>[] aesByte = cipher.doFinal(contentByte);<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> String(aesByte, StandardCharsets.UTF_8);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchAlgorithmException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchPaddingException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (InvalidKeyException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalBlockSizeException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (BadPaddingException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="jpype对jar包的调用"><a href="#jpype对jar包的调用" class="headerlink" title="jpype对jar包的调用"></a><code>jpype</code>对jar包的调用</h3><p>JPype是一个能够让Python代码方便地调用Java代码的工具，它的原理即调用JAVA虚拟机，并将Java方法的返回类型转换为Python类型。</p>
<p>本实验的jpype调用格式如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> jpype<br><span class="hljs-keyword">import</span> os<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-comment">#获取本机JVM路径</span><br>    jvmPath = jpype.getDefaultJVMPath()<br>    <span class="hljs-comment">#开启JVM，调用编译好的jar包</span><br>    jpype.startJVM(<br>        jvmPath, <span class="hljs-string">&quot;-ea&quot;</span>, <span class="hljs-string">&quot;-Djava.class.path=%s&quot;</span> %<br>        (<span class="hljs-string">&#x27;../out/artifacts/EncryptorDecryptor_jar/EncryptorDecryptor.jar&#x27;</span>))<br>    <span class="hljs-comment">#指定要操作的类</span><br>    MyAES = jpype.JClass(<span class="hljs-string">&quot;top.enatsu.MyAES&quot;</span>)<br>    ... <span class="hljs-comment">#调用MyAES类的方法。由于如前代码所示，AES加密解密均为静态方法，故不需创建MyAES实例</span><br>    <span class="hljs-comment">#关闭JVM</span><br>    jpype.shutdownJVM()<br></code></pre></td></tr></table></figure>



<h3 id="Thrift介绍"><a href="#Thrift介绍" class="headerlink" title="Thrift介绍"></a>Thrift介绍</h3><p>Thrift是一种接口描述语言和二进制通讯协议，它被用来定义和创建跨语言的服务，可视为一种远程过程调用（RPC）框架。它通过一个代码生成引擎联合了一个软件栈，来创建不同程度的、无缝的跨平台高效服务。它最早有Facebook开发，后来Facebook把它捐献给Apache软件基金会作为开源项目。</p>
<p>本实验需要编写thrift脚本：</p>
<figure class="highlight thrift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs thrift"><span class="hljs-class"><span class="hljs-keyword">service</span> <span class="hljs-title">MyAESService</span> </span>&#123;<br>  <span class="hljs-built_in">string</span> AESEncode(<span class="hljs-number">1</span>:<span class="hljs-built_in">string</span> encodeRules, <span class="hljs-number">2</span>:<span class="hljs-built_in">string</span> content)<br>  <span class="hljs-built_in">string</span> AESDecode(<span class="hljs-number">1</span>:<span class="hljs-built_in">string</span> encodeRules, <span class="hljs-number">2</span>:<span class="hljs-built_in">string</span> content)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>将脚本保存为<code>MyAESService.thrift</code>，执行以下指令，thrift自动生成目标语言的代码，分别保存在<code>gen-java</code>/<code>gen-cpp</code>/<code>gen-py</code>文件夹。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">thrift --gen java MyAESService.thrift<br>thrift --gen cpp MyAESService.thrift<br>thrift --gen py MyAESService.thrift<br></code></pre></td></tr></table></figure>

<p>在对应代码基础上实现即可。</p>
<p>对于作为服务端的Java，需要实现<code>MyAESService</code>的<code>Iface</code>接口中的<code>AESEncode</code>和<code>AESEncode</code>两个方法（减少耦合，直接在实现类<code>MyAESImpl</code>中调用前文所述方法即可）。</p>
<p>服务器端启动服务的代码结构如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.thrift.TProcessor;<br><span class="hljs-keyword">import</span> org.apache.thrift.protocol.TBinaryProtocol;<br><span class="hljs-keyword">import</span> org.apache.thrift.server.TServer;<br><span class="hljs-keyword">import</span> org.apache.thrift.server.TSimpleServer;<br><span class="hljs-keyword">import</span> org.apache.thrift.transport.TServerSocket;<br><span class="hljs-keyword">import</span> top.enatsu.thrift.common.MyAESImpl;<br><span class="hljs-keyword">import</span> top.enatsu.thrift.common.MyAESService;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ServerMain</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> SERVER_PORT = <span class="hljs-number">8090</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">startServer</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>                System.out.println(<span class="hljs-string">&quot;Start ....&quot;</span>);<br>                TProcessor tprocessor = <span class="hljs-keyword">new</span> MyAESService.Processor&lt;MyAESService.Iface&gt;(<span class="hljs-keyword">new</span> MyAESImpl()); <span class="hljs-comment">//负责调用用户定义的服务接口</span><br><br>                TServerSocket serverTransport = <span class="hljs-keyword">new</span> TServerSocket(SERVER_PORT); <span class="hljs-comment">//绑定端口</span><br>                TServer.Args tArgs = <span class="hljs-keyword">new</span> TServer.Args(serverTransport);<br>                tArgs.processor(tprocessor);<br>                <span class="hljs-comment">//指定Thrift二进制序列化协议。除TBinaryProtocol外还有压缩密集的TCompactProtocol等</span><br>                tArgs.protocolFactory(<span class="hljs-keyword">new</span> TBinaryProtocol.Factory()); <br><br>                TServer server = <span class="hljs-keyword">new</span> TSimpleServer(tArgs);<br>                server.serve();<br><br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                System.out.println(<span class="hljs-string">&quot;Server start error!!!&quot;</span>);<br>                e.printStackTrace();<br>            &#125;<br>    &#125;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>相应的客户端代码结构如下：</p>
<p>Python：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> MyAESService <span class="hljs-keyword">import</span> MyAESService<br>  <br><span class="hljs-keyword">from</span> thrift <span class="hljs-keyword">import</span> Thrift  <br><span class="hljs-keyword">from</span> thrift.transport <span class="hljs-keyword">import</span> TSocket  <br><span class="hljs-keyword">from</span> thrift.transport <span class="hljs-keyword">import</span> TTransport  <br><span class="hljs-keyword">from</span> thrift.protocol <span class="hljs-keyword">import</span> TBinaryProtocol  <br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    transport = TSocket.TSocket(<span class="hljs-string">&#x27;localhost&#x27;</span>, <span class="hljs-number">8090</span>) <span class="hljs-comment">#服务端的socket</span><br>    transport = TTransport.TBufferedTransport(transport) <span class="hljs-comment">#指定缓存传输</span><br>    protocol = TBinaryProtocol.TBinaryProtocol(transport)  <span class="hljs-comment">#指定协议</span><br>    client = MyAESService.Client(protocol)  <br>    transport.<span class="hljs-built_in">open</span>()<br>    ... <span class="hljs-comment">#具体调用client实例的方法</span><br>    transport.close()<br></code></pre></td></tr></table></figure>

<p>C++：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;MyAESService.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;thrift/protocol/TBinaryProtocol.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;thrift/transport/TSocket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;thrift/transport/TBufferTransports.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> apache::thrift;<br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> apache::thrift::protocol; <br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> apache::thrift::transport;<br><br>std::string serverIP = <span class="hljs-string">&quot;localhost&quot;</span>;<br><span class="hljs-keyword">int</span> serverPort = <span class="hljs-number">8090</span>;<br><br><span class="hljs-function">std::string <span class="hljs-title">AESEncode</span><span class="hljs-params">(std::string encodeRules, std::string content)</span> </span>&#123;<br><br>	<span class="hljs-function">std::shared_ptr&lt;TSocket&gt; <span class="hljs-title">socket</span><span class="hljs-params">(<span class="hljs-keyword">new</span> TSocket(serverIP, serverPort))</span></span>; <span class="hljs-comment">//服务端的socket</span><br>	<span class="hljs-function">std::shared_ptr&lt;TTransport&gt; <span class="hljs-title">transport</span><span class="hljs-params">(<span class="hljs-keyword">new</span> TBufferedTransport(socket))</span></span>;<span class="hljs-comment">//指定缓存传输</span><br>	<span class="hljs-function">std::shared_ptr&lt;TProtocol&gt; <span class="hljs-title">protocol</span><span class="hljs-params">(<span class="hljs-keyword">new</span> TBinaryProtocol(transport))</span></span>; <span class="hljs-comment">//指定协议</span><br>	<br>	transport-&gt;<span class="hljs-built_in">open</span>();<br>	MyAESServiceClient* client=<span class="hljs-keyword">new</span> <span class="hljs-built_in">MyAESServiceClient</span>(protocol);<br>	std::string _return;<br>	client-&gt;<span class="hljs-built_in">AESEncode</span>(_return,encodeRules, content);<br>	transport-&gt;<span class="hljs-built_in">close</span>();<br><br>	<span class="hljs-keyword">return</span> _return;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="附注：vcpkg简介"><a href="#附注：vcpkg简介" class="headerlink" title="附注：vcpkg简介"></a>附注：<code>vcpkg</code>简介</h3><p>我们再考虑安装包管理。Python的官方包管理工具为<code>pip</code>，也可用<code>conda</code>等；Java则可以用<code>maven</code>或<code>gradle</code>。而之前C++一直没有较为合适的包管理工具。</p>
<p>如今，VC++可以使用微软开源的<code>vcpkg</code>管理C++程序包，从而省却了大量的解决方案配置。</p>
<p>本实验中需要的操作：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs powershell">vcpkg install thrift<br>vcpkg install thrift:x64<span class="hljs-literal">-windows</span><br>vcpkg integrate install <span class="hljs-comment">&lt;# 集成到全局，在vcpkg根目录的scripts\buildsystems下生成nuget配置文件 #&gt;</span><br></code></pre></td></tr></table></figure>

<p>打开 Visual Studio 2019，选择工具-NuGet包管理器-程序包管理器设置。在选项窗口中，点击NuGet包管理器-程序包源，添加<code>vcpkg</code>生成的NuGet配置文件路径。</p>
<p><img src="/images/MW3-nuget%E7%A8%8B%E5%BA%8F%E5%8C%85%E6%BA%90.png" srcset="/img/loading.gif" lazyload alt="nuget程序包源"></p>
<p>最后管理NuGet解决方案包，安装<code>vcpkg</code>源下的配置文件，即可在C++代码中<code>#include</code>需要的Thrift头文件。</p>
<p><img src="/images/MW3-%E7%AE%A1%E7%90%86nuget%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E5%8C%85.png" srcset="/img/loading.gif" lazyload alt="管理nuget解决方案包"></p>
<h3 id="L2语言的调用程序命令结构"><a href="#L2语言的调用程序命令结构" class="headerlink" title="L2语言的调用程序命令结构"></a>L2语言的调用程序命令结构</h3><p>首先输入命令。<code>e</code>编码，<code>d</code>解码，<code>q</code>输出。</p>
<p>接着依次输入编码规则和要编码/解码的字符串，输出相应的结果，并重新解码/编码，校验无误。</p>
<p><img src="/images/MW3-%E6%8E%A7%E5%88%B6%E5%8F%B0%E8%BE%93%E5%87%BA%E7%A4%BA%E4%BE%8B.png" srcset="/img/loading.gif" lazyload alt="控制台输出示例"></p>
<h2 id="技术总结"><a href="#技术总结" class="headerlink" title="技术总结"></a>技术总结</h2><p>本次实验实现了一个简单的AES加密/解密的跨语言调用编程。尝试多种方法，完成了实验所有要求。</p>
<p>跨语言开发，能充分利用不同语言的优势，提高开发上的效率；但另一方面，由于调用框架协议的限制，往往需要经历序列化/反序列化过程，乃至基于网络，跨语言调用的运行效率往往不如本语言原生调用来得高。</p>
<p>如果无法实现直接的跨语言调用，可以考虑读取控制台输出，或者设计必要的Web API。</p>
<p>本实验尚有以下不足之处：</p>
<ul>
<li>未研究其他的加密解密算法</li>
<li>未尝试对文件的加密解密</li>
</ul>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/middleware/">中間件</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/cpp/">C++</a>
                    
                      <a class="hover-with-bg" href="/tags/python/">Python</a>
                    
                      <a class="hover-with-bg" href="/tags/java/">Java</a>
                    
                      <a class="hover-with-bg" href="/tags/thrift/">Thrift</a>
                    
                      <a class="hover-with-bg" href="/tags/jpype/">JPype</a>
                    
                      <a class="hover-with-bg" href="/tags/vcpkg/">vcpkg</a>
                    
                      <a class="hover-with-bg" href="/tags/base64/">Base64</a>
                    
                      <a class="hover-with-bg" href="/tags/aes/">AES</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本站所有文章除特別聲明外，均採用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 協議</a> ，轉載請註明出處！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/nlp/RNNBasedNLGModels/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">基于RNN的语言生成模型</span>
                        <span class="visible-mobile">前篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/git/WebhookStart/">
                        <span class="hidden-mobile">GitHub Webhook远程服务器自动部署杂记</span>
                        <span class="visible-mobile">後篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目錄</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">檢索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">關鍵詞</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <div> <a target="_blank" rel="noopener" href='https://blog.enatsu.top'>Enatsu's Site</a> <span> © 2019-</span><span id='this_year'></span> </div> <div> <span>Powered by</span> <a href='https://hexo.io' target='_blank' rel='nofollow noopener'><span>Hexo</span></a> <i class='iconfont icon-love'></i> <a href='https://github.com/fluid-dev/hexo-theme-fluid' target='_blank' rel='nofollow noopener'> <span>Fluid</span></a> </div> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            <i class="iconfont icon-eye"></i> 
            <span id="busuanzi_value_site_pv"></span>
            
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            <i class="iconfont icon-users"></i> 
            <span id="busuanzi_value_site_uv"></span>
            
          </span>
      
    
  </div>


  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.staticfile.org/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.6.0/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- OpenCC -->
<script  src="/opencc-js/1.0.3/data.min.js" ></script>
<script  src="/opencc-js/1.0.3/data.t2cn.min.js" ></script>
<script  src="/opencc-js/1.0.3/bundle-browser.min.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.staticfile.org/tocbot/4.12.0/tocbot.min.js" ></script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.3.1/anchor.min.js" ></script>



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.8/clipboard.min.js" ></script>



  <script  src="/js/local-search.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.bootcdn.net/ajax/libs/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>





  

  
    <!-- MathJax -->
    <script>
      MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']]
        },
        options: {
          renderActions: {
            findScript: [10, doc => {
              document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
                const display = !!node.type.match(/; *mode=display/);
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
                const text = document.createTextNode('');
                node.parentNode.replaceChild(text, node);
                math.start = { node: text, delim: '', n: 0 };
                math.end = { node: text, delim: '', n: 0 };
                doc.math.push(math);
              });
            }, '', false],
            insertedScript: [200, () => {
              document.querySelectorAll('mjx-container').forEach(node => {
                let target = node.parentNode;
                if (target.nodeName.toLowerCase() === 'li') {
                  target.parentNode.classList.add('has-jax');
                }
              });
            }, '', false]
          }
        }
      };
    </script>

    <script async src="https://cdn.staticfile.org/mathjax/3.1.4/es5/tex-svg.js" ></script>

  










  
<script src="/js/custom.js"></script>
<script src="/js/jquery.cookie.js"></script>



<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
